<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Filtrar Bowls â€” Fit Express</title>
  <style>
    :root{ --text:#ecfdf5; --muted:#b7e4cf; --panel:#0e2a1a; --ring:rgba(34,197,94,.35); --accent:#22c55e; --cta:#6d28d9; --cta-text:#f9f5ff; }
    *{box-sizing:border-box} html,body{margin:0;height:100%}
    body{font-family:system-ui,sans-serif;background:#0b1f14;color:var(--text)}
    
    header{ position:sticky; top:0; z-index:10; backdrop-filter:blur(8px); background:linear-gradient(180deg, rgba(11,42,24,.9), rgba(11,42,24,.65)); border-bottom:1px solid rgba(183,210,192,.18); padding: 8px 0; }
    .container{max-width:900px;margin:0 auto;padding:0 16px}
    .topbar{ display:flex; align-items:center; justify-content:space-between; height: 60px; }
    .logo{ font-weight:900; color:#fff; text-decoration:none; font-size:20px; display:flex; align-items:center; gap:10px; }
    .logo span{ background:#19c268; padding:4px 8px; border-radius:6px; font-size:14px; }
    .icon-btn{display:grid;place-items:center;width:40px;height:40px;border-radius:12px;border:1px solid rgba(183,210,192,.25);background:rgba(17, 57, 35, 0.6);text-decoration:none;color:white}
    .cart-badge { position: absolute; top: -5px; right: -5px; background: var(--cta); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; }

    .main-content { padding: 40px 16px; min-height: calc(100vh - 140px); }
    .filter-header { text-align: center; margin-bottom: 30px; }
    .filter-title { font-size: 32px; margin: 0 0 10px 0; }
    
    /* Panel de Filtros Estilo "Card" */
    .filters-section { background: linear-gradient(180deg, rgba(18,56,35,.85), rgba(10,38,23,.85)); border: 1px solid rgba(183,210,192,.18); border-radius: 20px; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    
    .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; margin-bottom: 40px; }
    
    .filter-group h3 { font-size: 18px; color: var(--accent); margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
    
    /* Checkboxes Personalizados */
    .filter-option { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; cursor: pointer; transition: .2s; }
    .filter-option:hover { opacity: 0.8; }
    .filter-option.disabled { opacity: 0.3; pointer-events: none; text-decoration: line-through; }
    
    input[type="checkbox"] { appearance: none; width: 20px; height: 20px; border: 2px solid var(--muted); border-radius: 5px; background: transparent; cursor: pointer; position: relative; }
    input[type="checkbox"]:checked { background: var(--accent); border-color: var(--accent); }
    input[type="checkbox"]:checked::after { content: 'âœ”'; position: absolute; color: #000; font-size: 14px; left: 3px; top: -1px; font-weight: bold; }
    
    .filter-actions { display: flex; justify-content: center; gap: 20px; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 30px; }
    .btn { padding: 14px 30px; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; border: none; transition: .2s; min-width: 160px; }
    .btn-apply { background: var(--cta); color: white; box-shadow: 0 5px 15px rgba(109, 40, 217, 0.3); }
    .btn-apply:hover { transform: translateY(-2px); filter: brightness(1.1); }
    .btn-reset { background: transparent; border: 1px solid var(--muted); color: var(--muted); }
    .btn-reset:hover { border-color: var(--text); color: var(--text); }

    footer{ padding:30px; text-align:center; border-top:1px solid rgba(255,255,255,0.1); margin-top: 40px; color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="container topbar">
      <a href="index.html" class="logo"><span>FE</span> Fit Express</a>
      <div style="display:flex;gap:10px">
        <a href="B02-InicioSesion.html" class="icon-btn">ðŸ‘¤</a>
        <a href="B09-Carrito.html" class="icon-btn">ðŸ›’ <span class="cart-badge" id="cartBadge">0</span></a>
      </div>
    </div>
  </header>

  <div class="main-content container">
    <div class="filter-header">
      <h1 class="filter-title">Encuentra tu Bowl Ideal</h1>
      <p style="color:var(--muted)">Selecciona tus preferencias y te mostraremos lo mejor para ti.</p>
    </div>

    <section class="filters-section">
      <div class="filters-grid">
        
        <div class="filter-group">
          <h3>ProteÃ­na Principal</h3>
          <label class="filter-option" data-type="meat">
            <input type="checkbox" name="protein" value="chicken"> Pollo
          </label>
          <label class="filter-option" data-type="meat">
            <input type="checkbox" name="protein" value="beef"> Carne
          </label>
          <label class="filter-option" data-type="meat">
            <input type="checkbox" name="protein" value="fish"> Pescado / AtÃºn
          </label>
          <label class="filter-option">
            <input type="checkbox" id="veganCheck" name="protein" value="vegan"> Vegano / Vegetariano
          </label>
        </div>

        <div class="filter-group">
          <h3>Objetivo CalÃ³rico</h3>
          <label class="filter-option"><input type="checkbox" name="calories" value="low"> Ligero (< 400 kcal)</label>
          <label class="filter-option"><input type="checkbox" name="calories" value="medium"> Balanceado (400-500 kcal)</label>
          <label class="filter-option"><input type="checkbox" name="calories" value="high"> Power (> 500 kcal)</label>
        </div>

        <div class="filter-group">
          <h3>Rango de Precio</h3>
          <label class="filter-option"><input type="checkbox" name="price" value="low"> EconÃ³mico (< $8.000)</label>
          <label class="filter-option"><input type="checkbox" name="price" value="medium"> EstÃ¡ndar ($8.000 - $9.000)</label>
          <label class="filter-option"><input type="checkbox" name="price" value="high"> Premium (> $9.000)</label>
        </div>
      </div>

      <div class="filter-actions">
        <button class="btn btn-reset" id="resetFilters">Limpiar</button>
        <button class="btn btn-apply" id="applyFilters">Cargando...</button>
      </div>
    </section>
  </div>

  <footer>Â© <span id="y"></span> Fit Express</footer>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
    const API_URL = "http://127.0.0.1:8000";
    let allProducts = [];

    const applyBtn = document.getElementById('applyFilters');
    const resetBtn = document.getElementById('resetFilters');
    const veganCheck = document.getElementById('veganCheck');
    const meatOptions = document.querySelectorAll('[data-type="meat"]');

    // 1. CARGAR DATOS
    document.addEventListener('DOMContentLoaded', async () => {
        updateCartBadge();
        await fetchProducts();
        // Si vuelves atrÃ¡s, recuperar filtros anteriores
        loadSavedFilters(); 
        updateCount();
    });

    async function fetchProducts() {
        try {
            const res = await fetch(`${API_URL}/catalogo/productos`);
            if(res.ok) allProducts = await res.json();
            else applyBtn.textContent = "Ver Resultados (Error)";
        } catch(e) { console.error(e); }
    }

    // 2. LÃ“GICA INTELIGENTE (Vegano bloquea carnes)
    veganCheck.addEventListener('change', () => {
        meatOptions.forEach(opt => {
            const input = opt.querySelector('input');
            if (veganCheck.checked) {
                input.checked = false;
                opt.classList.add('disabled');
            } else {
                opt.classList.remove('disabled');
            }
        });
        updateCount();
    });

    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', updateCount);
    });

    // 3. CALCULAR RESULTADOS (LÃ“GICA MEJORADA)
    function updateCount() {
        const filters = getSelectedFilters();
        const hasFilters = Object.values(filters).some(arr => arr.length > 0);
        
        if(!hasFilters) {
            applyBtn.textContent = `Ver Todos (${allProducts.length})`;
            return;
        }

        const count = allProducts.filter(p => filterProduct(p, filters)).length;
        applyBtn.textContent = `Ver (${count}) Bowls Filtrados`;
    }

    // Esta es la funciÃ³n clave que usaremos tambiÃ©n en B05
    function filterProduct(p, filters) {
        if (p.tipo !== 'bowl') return false;

        const name = p.nombre.toLowerCase();
        const desc = (p.descripcion || "").toLowerCase();
        const kcal = p.macros ? p.macros.kcal : 0;
        const price = p.precio_base;

        // ProteÃ­na (BÃºsqueda flexible)
        if(filters.protein.length > 0) {
            let match = false;
            if(filters.protein.includes('chicken') && (name.includes('pollo') || desc.includes('pollo'))) match = true;
            if(filters.protein.includes('beef') && (name.includes('carne') || desc.includes('carne') || desc.includes('res'))) match = true;
            if(filters.protein.includes('fish') && (name.includes('pescado') || name.includes('atun') || name.includes('salmon') || name.includes('mediterraneo'))) match = true;
            if(filters.protein.includes('vegan') && (name.includes('vegano') || name.includes('quinoa') || desc.includes('falafel') || desc.includes('tofu'))) match = true;
            if(!match) return false;
        }

        // CalorÃ­as
        if(filters.calories.length > 0) {
            let match = false;
            if(filters.calories.includes('low') && kcal < 400) match = true;
            if(filters.calories.includes('medium') && kcal >= 400 && kcal <= 500) match = true;
            if(filters.calories.includes('high') && kcal > 500) match = true;
            if(!match) return false;
        }

        // Precio
        if(filters.price.length > 0) {
            let match = false;
            if(filters.price.includes('low') && price < 8000) match = true;
            if(filters.price.includes('medium') && price >= 8000 && price <= 9000) match = true;
            if(filters.price.includes('high') && price > 9000) match = true;
            if(!match) return false;
        }
        return true;
    }

    // 4. GUARDAR Y NAVEGAR
    function getSelectedFilters() {
        const filters = { protein: [], calories: [], price: [] };
        document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
            filters[cb.name].push(cb.value);
        });
        return filters;
    }

    applyBtn.addEventListener('click', () => {
        localStorage.setItem('bowlFilters', JSON.stringify(getSelectedFilters()));
        window.location.href = 'B05-CatalogoMacros.html';
    });

    resetBtn.addEventListener('click', () => {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
            cb.parentElement.classList.remove('disabled');
        });
        updateCount();
    });

    function loadSavedFilters() {
        const saved = JSON.parse(localStorage.getItem('bowlFilters'));
        if(saved) {
            for (const [key, values] of Object.entries(saved)) {
                values.forEach(val => {
                    const el = document.querySelector(`input[name="${key}"][value="${val}"]`);
                    if(el) el.checked = true;
                });
            }
            if(veganCheck.checked) veganCheck.dispatchEvent(new Event('change'));
        }
    }

    async function updateCartBadge() {
        const token = localStorage.getItem('access_token');
        const badge = document.getElementById('cartBadge');
        if (token) {
            try {
                const res = await fetch(`${API_URL}/carrito/`, { headers: { 'Authorization': `Bearer ${token}` }});
                if(res.ok) {
                    const data = await res.json();
                    badge.textContent = data.items.reduce((acc, i) => acc + i.cantidad, 0);
                }
            } catch(e){}
        } else {
            const cart = JSON.parse(localStorage.getItem('fitExpressCart')) || [];
            badge.textContent = cart.reduce((acc, i) => acc + i.quantity, 0);
        }
    }
  </script>
</body>
</html>