<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>CatÃ¡logo saludable â€” Fit Express</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* --- ESTILOS BASE --- */
    :root{ --text:#ecfdf5; --muted:#b7e4cf; --panel:#0e2a1a; --accent:#22c55e; --cta:#6d28d9; --err:#ef4444; }
    *{box-sizing:border-box} html,body{margin:0;height:100%}
    body{font-family:system-ui,sans-serif;background:#0b1f14;color:var(--text)}
    
    header{ position:sticky; top:0; z-index:10; backdrop-filter:blur(8px); background:linear-gradient(180deg, rgba(11,42,24,.9), rgba(11,42,24,.65)); border-bottom:1px solid rgba(183,210,192,.18); padding: 8px 0; }
    .container{max-width:1200px;margin:0 auto;padding:0 16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;height:60px}
    .logo{font-weight:900;color:#fff;text-decoration:none;font-size:20px;display:flex;align-items:center;gap:10px}
    .logo span{background:#19c268;padding:4px 8px;border-radius:6px;font-size:14px}
    .icon-btn{display:grid;place-items:center;width:40px;height:40px;border-radius:12px;border:1px solid rgba(183,210,192,.25);background:rgba(17, 57, 35, 0.6);text-decoration:none;color:white;position:relative}
    .cart-badge { position: absolute; top: -5px; right: -5px; background: var(--cta); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; }

    .main-content { padding: 40px 16px; min-height: calc(100vh - 140px); }
    .catalog-header { text-align: center; margin-bottom: 30px; }
    .catalog-title { font-size: 32px; margin: 0 0 20px 0; }
    
    /* Filtros */
    .filters { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
    .filter-btn { background: rgba(17, 57, 35, 0.6); color: var(--text); border: 1px solid rgba(183,210,192,.25); border-radius: 12px; padding: 12px 24px; font-weight: 700; text-decoration: none; transition: .2s; }
    .filter-btn:hover { border-color: var(--accent); background: rgba(34,197,94,.15); transform: translateY(-2px); }
    
    .filter-indicator { background: var(--accent); color: #052e16; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 700; margin-bottom: 20px; display: inline-block; }
    .clear-filters { background: none; border: none; color: #052e16; text-decoration: underline; cursor: pointer; margin-left: 10px; font-weight: 700; }

    /* Grid */
    .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 25px; }
    
    .product-card { background: linear-gradient(180deg, rgba(18,56,35,.85), rgba(10,38,23,.85)); border: 1px solid rgba(183,210,192,.18); border-radius: 12px; overflow: hidden; transition: .3s; display: flex; flex-direction: column; }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,.3); border-color: rgba(183,210,192,.4); }
    .product-card.unavailable { filter: grayscale(100%); opacity: 0.7; pointer-events: none; }
    
    .product-image { height: 180px; background-size: cover; background-position: center; position: relative; }
    .product-content { padding: 16px; flex: 1; display: flex; flex-direction: column; }
    .product-name { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    .product-macros { font-size: 12px; color: var(--muted); margin-bottom: 8px; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px; width: fit-content; }
    .product-price { font-size: 20px; font-weight: 700; color: var(--accent); margin-top: auto; margin-bottom: 10px; }
    
    .btn-add-cart { background: var(--cta); color: white; border: none; border-radius: 8px; padding: 12px; font-weight: 700; cursor: pointer; width: 100%; transition: .2s; }
    .btn-add-cart:hover { filter: brightness(1.1); }

    footer{ padding:30px; color:var(--muted); text-align:center; border-top:1px solid rgba(183,210,192,.18); margin-top: 40px; }
    .toast { position: fixed; bottom: 20px; right: 20px; background: var(--cta); color: white; padding: 12px 20px; border-radius: 8px; z-index: 100; display: none; }
    .toast.show { display: block; }
  </style>
</head>
<body>
  <header>
    <div class="container topbar">
      <a href="index.html" class="logo"><span>FE</span> Fit Express</a>
      <nav class="actions" style="display:flex;gap:10px">
        <a href="B02-InicioSesion.html" class="icon-btn">ðŸ‘¤</a>
        <a href="B09-Carrito.html" class="icon-btn">ðŸ›’ <span class="cart-badge" id="cartBadge">0</span></a>
      </nav>
    </div>
  </header>

  <div class="main-content container">
    <div class="catalog-header">
      <h1 class="catalog-title">CatÃ¡logo Saludable</h1>
      
      <div id="filterIndicator" style="display: none;">
        <div class="filter-indicator">
          Filtros activos: <span id="filterCount">0</span>
          <button class="clear-filters" onclick="clearFilters()">Borrar Filtros</button>
        </div>
      </div>
      
      <div class="filters">
        <a href="B06-FiltroBowl.html" class="filter-btn">Filtrar por Dieta</a>
        <a href="B08-PromocionesCombos.html" class="filter-btn">Ver Combos</a>
        <a href="B10-PesonalizacionExtras.html" class="filter-btn">Personalizar</a>
      </div>
    </div>

    <div class="products-grid" id="productsGrid">
      <p style="grid-column:1/-1;text-align:center;color:#ccc">Cargando productos...</p>
    </div>

    <div style="text-align:center;margin-top:20px;color:#888" id="resultsCount"></div>
  </div>

  <div class="toast" id="toast">Producto agregado</div>
  <footer>Â© <span id="y"></span> Fit Express</footer>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
    const API_URL = "http://127.0.0.1:8000";
    
    // Variable para guardar todos los productos antes de filtrar
    let allProducts = [];

    document.addEventListener('DOMContentLoaded', async () => {
        updateCartBadge();
        await loadProducts();
    });

    // 1. Cargar todo desde BD
    async function loadProducts() {
        try {
            const res = await fetch(`${API_URL}/catalogo/productos`);
            if (!res.ok) throw new Error("Error API");
            
            allProducts = await res.json();
            
            // APLICAR FILTROS GUARDADOS
            const savedFilters = JSON.parse(localStorage.getItem('bowlFilters'));
            
            if (savedFilters && Object.values(savedFilters).some(arr => arr.length > 0)) {
                applyFilters(savedFilters);
            } else {
                renderGrid(allProducts); // Mostrar todo si no hay filtros
            }

        } catch (e) {
            console.error(e);
            document.getElementById('productsGrid').innerHTML = '<p>Error cargando el catÃ¡logo.</p>';
        }
    }

    // 2. LÃ³gica de Filtrado (LA MISMA DE B06)
    function applyFilters(filters) {
        document.getElementById('filterIndicator').style.display = 'block';
        
        const filtered = allProducts.filter(p => {
            if (p.tipo !== 'bowl') return false; // Filtro B06 es solo para bowls

            const name = p.nombre.toLowerCase();
            const desc = (p.descripcion || "").toLowerCase();
            const kcal = p.macros ? p.macros.kcal : 0;
            const price = p.precio_base;

            // ProteÃ­na
            if(filters.protein.length > 0) {
                let match = false;
                if(filters.protein.includes('chicken') && (name.includes('pollo') || desc.includes('pollo'))) match = true;
                if(filters.protein.includes('beef') && (name.includes('carne') || desc.includes('res'))) match = true;
                if(filters.protein.includes('fish') && (name.includes('pescado') || name.includes('atun') || name.includes('mediterraneo'))) match = true;
                if(filters.protein.includes('vegan') && (name.includes('vegano') || name.includes('quinoa') || desc.includes('tofu'))) match = true;
                if(!match) return false;
            }

            // CalorÃ­as
            if(filters.calories.length > 0) {
                let match = false;
                if(filters.calories.includes('low') && kcal < 400) match = true;
                if(filters.calories.includes('medium') && kcal >= 400 && kcal <= 500) match = true;
                if(filters.calories.includes('high') && kcal > 500) match = true;
                if(!match) return false;
            }

            // Precio
            if(filters.price.length > 0) {
                let match = false;
                if(filters.price.includes('low') && price < 8000) match = true;
                if(filters.price.includes('medium') && price >= 8000 && price <= 9000) match = true;
                if(filters.price.includes('high') && price > 9000) match = true;
                if(!match) return false;
            }
            return true;
        });

        document.getElementById('filterCount').textContent = filtered.length;
        renderGrid(filtered);
    }

    function clearFilters() {
        localStorage.removeItem('bowlFilters');
        document.getElementById('filterIndicator').style.display = 'none';
        renderGrid(allProducts);
    }

    // 3. Renderizar
    function renderGrid(products) {
        const grid = document.getElementById('productsGrid');
        grid.innerHTML = '';
        
        if (products.length === 0) {
            grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;margin-top:40px;color:#888">No se encontraron productos con esos filtros.</p>';
            document.getElementById('resultsCount').textContent = '';
            return;
        }

        products.forEach(p => {
            const precio = `$${p.precio_base.toLocaleString('es-CL')}`;
            const macros = p.macros ? `${p.macros.kcal} kcal | P:${p.macros.p}g` : 'Info pendiente';
            const img = p.imagen_url || 'img/default.jpg';
            const isAvailable = p.disponible;
            const btnState = isAvailable ? '' : 'disabled';
            const btnText = isAvailable ? 'Agregar al Carrito' : 'Agotado';
            const cardClass = isAvailable ? 'product-card' : 'product-card unavailable';

            const html = `
            <div class="${cardClass}">
                <div class="product-image" style="background-image: url('${img}')"></div>
                <div class="product-content">
                    <div class="product-name">${p.nombre}</div>
                    <div class="product-macros">${macros}</div>
                    <div class="product-price">${precio}</div>
                    
                    <button class="btn-add-cart" 
                            onclick="addToCart(${p.id}, '${p.nombre}')" 
                            ${btnState}>
                        ${btnText}
                    </button>
                </div>
            </div>
            `;
            grid.insertAdjacentHTML('beforeend', html);
        });

        document.getElementById('resultsCount').textContent = `Mostrando ${products.length} productos`;
    }

    // 4. Carrito
    async function addToCart(id, name) {
        const token = localStorage.getItem('access_token');
        if (token) {
            try {
                await fetch(`${API_URL}/carrito/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ producto_id: id, cantidad: 1 })
                });
                showToast(`âœ… ${name} agregado`);
                updateCartBadge();
            } catch(e) { showToast("Error de conexiÃ³n"); }
        } else {
            let cart = JSON.parse(localStorage.getItem('fitExpressCart')) || [];
            const exist = cart.find(i => i.id === id);
            if(exist) exist.quantity++; else cart.push({ id, quantity: 1 });
            localStorage.setItem('fitExpressCart', JSON.stringify(cart));
            showToast(`âœ… ${name} agregado (Local)`);
            updateCartBadge();
        }
    }

    async function updateCartBadge() {
        const token = localStorage.getItem('access_token');
        const badge = document.getElementById('cartBadge');
        if (token) {
            try {
                const res = await fetch(`${API_URL}/carrito/`, { headers: { 'Authorization': `Bearer ${token}` }});
                if(res.ok) {
                    const data = await res.json();
                    badge.textContent = data.items.reduce((acc, i) => acc + i.cantidad, 0);
                }
            } catch(e){}
        } else {
            const cart = JSON.parse(localStorage.getItem('fitExpressCart')) || [];
            badge.textContent = cart.reduce((acc, i) => acc + i.quantity, 0);
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }
  </script>
</body>
</html>