<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Restablecer contraseña — Fit Express</title>
  <style>
    :root{
      --text:#ecfdf5; --muted:#b7e4cf; --panel:#0e2a1a; --ring:rgba(34,197,94,.35);
      --accent:#22c55e; --cta:#6d28d9; --cta-text:#f9f5ff;
      --hero-overlay: radial-gradient(900px 700px at 110% -10%, rgba(34,197,94,.30) 0%, rgba(34,197,94,0) 60%);
    }
    *{box-sizing:border-box} html,body{margin:0;height:100%}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;background:#0b1f14;color:var(--text)}

    /* Header */
    header{ position:sticky; top:0; z-index:10; backdrop-filter:blur(8px); background:linear-gradient(180deg, rgba(11,42,24,.9), rgba(11,42,24,.65)); border-bottom:1px solid rgba(183,210,192,.18); padding:8px 0; }
    .container{max-width:1200px;margin:0 auto;padding:0 16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;height:60px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:900}
    .logo{width:32px;height:32px;border-radius:8px;background:#19c268;box-shadow:0 0 18px #19c268 inset,0 0 18px #19c268;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;font-size:14px}
    .brand span{font-size:20px;color:var(--text)}
    .actions{display:flex;align-items:center;gap:10px;margin-left:auto}
    .link{color:var(--muted);text-decoration:none;border:1px solid rgba(183,210,192,.25);padding:10px 14px;border-radius:12px;background:rgba(17,57,35,.6);transition:.2s}
    .link:hover{border-color:var(--accent);background:rgba(34,197,94,.15);box-shadow:0 4px 12px rgba(34,197,94,.2)}

    /* Layout */
    .wrap{ min-height:calc(100dvh - 60px); display:grid;place-items:center; padding:32px 16px; background: var(--hero-overlay), radial-gradient(1000px 700px at -10% -10%, rgba(34,197,94,.08) 0%, rgba(34,197,94,0) 60%); }

    /* Card */
    .card{ width:100%; max-width:720px; background:linear-gradient(180deg, rgba(18,56,35,.65), rgba(10,38,23,.65)); border:1px solid rgba(183,210,192,.18); border-radius:20px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.3); display:grid; grid-template-columns:1fr 1fr; }
    @media (max-width:860px){.card{grid-template-columns:1fr}}

    .card-media{ background: linear-gradient(180deg, rgba(18,56,35,.35), rgba(10,38,23,.8)), url('https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&w=500&q=80') center/cover no-repeat; min-height:260px; display:flex;flex-direction:column;justify-content:flex-end;gap:10px; padding:20px; border-right:1px solid rgba(183,210,192,.18); }
    .pill{display:inline-block;background:#d1fae5;color:#065f46;padding:6px 12px;border-radius:999px;font-weight:800;font-size:12px}
    .media-title{margin:6px 0 0;font-size:22px}
    .media-sub{margin:0;color:var(--muted);font-size:14px}

    .card-body{padding:22px}
    .card-body h1{margin:0 0 6px;font-size:clamp(22px,3.6vw,28px)}
    .card-body p.lead{margin:0 0 18px;color:var(--muted)}

    /* Stepper */
    .steps{display:flex;gap:8px;margin:10px 0 22px}
    .step{flex:1;height:6px;border-radius:999px;background:rgba(183,210,192,.25);overflow:hidden}
    .step.active{background:linear-gradient(90deg, var(--accent), #16a34a)}

    /* Form */
    form{display:grid;gap:14px}
    .field{display:grid;gap:8px}
    label{font-size:14px;color:#d1fae5}
    input{ width:100%;padding:14px 12px;border-radius:12px;border:1px solid rgba(183,210,192,.25); background:rgba(17,57,35,.6);color:var(--text);outline:none;transition:.2s }
    input:focus{border-color:var(--accent);box-shadow:0 0 0 4px var(--ring)}
    .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}

    .btn{ display:inline-flex;align-items:center;justify-content:center;gap:8px; padding:14px 16px;border-radius:12px;border:1px solid rgba(0,0,0,.15); font-weight:800;text-decoration:none;cursor:pointer;transition:.2s }
    .btn-primary{background:var(--cta);color:var(--cta-text)}
    .btn-primary:hover{filter:brightness(.92);transform:translateY(-1px);box-shadow:0 8px 20px rgba(109,40,217,.3)}
    .btn-ghost{background:transparent;color:var(--muted);border-color:rgba(183,210,192,.25)}
    .btn-ghost:hover{border-color:var(--accent);background:rgba(34,197,94,.08);color:var(--text)}

    .hint{font-size:12px;color:var(--muted)}
    .code-box{letter-spacing:6px;text-align:center;font-weight:800}

    /* Toasts */
    .toasts{position:fixed;inset:auto 16px 16px auto;display:grid;gap:10px;z-index:50}
    .toast{background:#052e16;color:#d1fae5;border:1px solid rgba(183,210,192,.25);border-left:4px solid var(--accent);padding:12px 14px;border-radius:12px;box-shadow:0 10px 22px rgba(0,0,0,.35)}
    .toast.err{border-left-color:#ef4444}

    footer{padding:26px 16px;color:var(--muted);text-align:center;border-top:1px solid rgba(183,210,192,.18);background:var(--panel);margin-top:32px}
    .back{display:inline-flex;align-items:center;gap:8px;margin:8px 0 16px;color:var(--muted);text-decoration:none}
    .back:hover{color:var(--text)}
  </style>
</head>
<body>
  <header>
    <div class="container topbar">
      <div class="brand"><div class="logo">FE</div><span>Fit Express</span></div>
      <nav class="actions"><a class="link" href="B02-InicioSesion.html">Volver a Login</a></nav>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <aside class="card-media">
        <span class="pill">Seguridad</span>
        <h2 class="media-title">Restablece tu contraseña</h2>
        <p class="media-sub">Ingresa tu correo y sigue los pasos.</p>
      </aside>

      <section class="card-body">
        <a href="B02-InicioSesion.html" class="back">← Volver</a>
        <h1 id="titulo">¿Olvidaste tu contraseña?</h1>
        <p class="lead">Sigue estos pasos para recuperar tu acceso.</p>

        <div class="steps">
          <div class="step active" id="s1"></div>
          <div class="step" id="s2"></div>
          <div class="step" id="s3"></div>
        </div>

        <form id="step1">
          <div class="field">
            <label for="email">Correo electrónico</label>
            <input id="email" type="email" placeholder="tucorreo@ejemplo.com" required />
            <span class="hint">Te enviaremos un código de verificación.</span>
          </div>
          <button class="btn btn-primary" type="submit">Enviar código</button>
        </form>

        <form id="step2" style="display:none">
          <div class="field">
            <label>Código de verificación</label>
            <input id="code" class="code-box" type="text" maxlength="6" placeholder="••••••" required />
            <span class="hint">Para la demo usa el código: <b>123456</b></span>
          </div>
          <div class="row">
            <button class="btn btn-ghost" type="button" onclick="setStep(1)">Atrás</button>
            <button class="btn btn-primary" type="submit">Validar código</button>
          </div>
        </form>

        <form id="step3" style="display:none">
          <div class="field">
            <label>Nueva contraseña</label>
            <input id="pass1" type="password" required minlength="4" />
          </div>
          <div class="field">
            <label>Repetir contraseña</label>
            <input id="pass2" type="password" required minlength="4" />
          </div>
          <div class="row">
            <button class="btn btn-ghost" type="button" onclick="setStep(2)">Atrás</button>
            <button class="btn btn-primary" type="submit">Cambiar y Entrar</button>
          </div>
        </form>
      </section>
    </div>
  </main>

  <div class="toasts" id="toasts"></div>
  <footer>© <span id="y"></span> Fit Express</footer>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
    const API_URL = "http://127.0.0.1:8000";

    const qs = s => document.querySelector(s);
    const step1 = qs('#step1'), step2 = qs('#step2'), step3 = qs('#step3');
    const s1 = qs('#s1'), s2 = qs('#s2'), s3 = qs('#s3');

    function setStep(n){
      [s1,s2,s3].forEach((e,i)=> e.classList.toggle('active', i < n));
      step1.style.display = 'none'; step2.style.display = 'none'; step3.style.display = 'none';
      if(n===1) step1.style.display = '';
      if(n===2) step2.style.display = '';
      if(n===3) step3.style.display = '';
    }

    function toast(msg, err=false){
      const box = qs('#toasts');
      const t = document.createElement('div');
      t.className = 'toast' + (err ? ' err' : '');
      t.textContent = msg;
      box.appendChild(t);
      setTimeout(()=>{ t.remove(); }, 4000);
    }

    // Paso 1
    step1.addEventListener('submit', (e)=>{
      e.preventDefault();
      const email = qs('#email').value.trim();
      if(!email) return toast('Ingresa tu correo', true);
      localStorage.setItem('fe_reset_email', email);
      toast('Código enviado a ' + email);
      setStep(2);
    });

    // Paso 2 (Validación simulada)
    step2.addEventListener('submit', (e)=>{
      e.preventDefault();
      const code = qs('#code').value.trim();
      if(code !== '123456') return toast('Código incorrecto. Usa 123456', true);
      toast('Código verificado');
      setStep(3);
    });

    // Paso 3 (Llamada REAL al Backend)
    step3.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const p1 = qs('#pass1').value;
      const p2 = qs('#pass2').value;
      
      if(p1 !== p2) return toast('Las contraseñas no coinciden', true);
      
      const email = localStorage.getItem('fe_reset_email');
      const btn = e.target.querySelector('button[type="submit"]');
      btn.textContent = "Guardando..."; btn.disabled = true;

      try {
        const res = await fetch(`${API_URL}/auth/restablecer-password`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email: email, new_password: p1 })
        });

        if(res.ok) {
            toast('¡Contraseña actualizada! Redirigiendo...');
            setTimeout(()=>{ window.location.href = 'B02-InicioSesion.html'; }, 2000);
        } else {
            const err = await res.json();
            toast(err.detail || 'Error al actualizar', true);
            btn.textContent = "Intentar de nuevo"; btn.disabled = false;
        }
      } catch(err) {
        toast('Error de conexión con el servidor', true);
        btn.disabled = false;
      }
    });

    setStep(1);
  </script>
</body>
</html>