<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi Perfil - Fit Express</title>
  <style>
    /* --- ESTILOS EXISTENTES --- */
    :root{--text:#ecfdf5;--muted:#b7e4cf;--panel:#0e2a1a;--ring:rgba(34,197,94,.35);--accent:#22c55e;--cta:#6d28d9;--cta-text:#f9f5ff;--error:#ef4444;--success:#10b981;--warning:#f59e0b;--hero-overlay:radial-gradient(900px 700px at 110% -10%,rgba(34,197,94,.30) 0%,rgba(34,197,94,0) 60%)}*{box-sizing:border-box}html,body{margin:0;height:100%}body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;background:#0b1f14;color:var(--text)}header{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);background:linear-gradient(180deg,rgba(11,42,24,.9),rgba(11,42,24,.65));border-bottom:1px solid rgba(183,210,192,.18);padding:8px 0}.container{max-width:1200px;margin:0 auto;padding:0 16px}.topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;height:60px}.brand{display:flex;align-items:center;gap:12px;font-weight:900;flex-shrink:0;text-decoration:none;color:inherit}.logo{width:32px;height:32px;border-radius:8px;background:#19c268;box-shadow:0 0 18px #19c268 inset,0 0 18px #19c268;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:14px}.brand span{font-size:20px;color:var(--text)}.actions{display:flex;align-items:center;gap:16px;margin-left:auto}.icon-btn{display:inline-grid;place-items:center;width:40px;height:40px;border-radius:12px;border:1px solid rgba(183,210,192,.25);background:rgba(17,57,35,.6);text-decoration:none;transition:all .2s ease;position:relative}.icon-btn:hover{border-color:var(--accent);background:rgba(34,197,94,.15);transform:translateY(-1px);box-shadow:0 4px 12px rgba(34,197,94,.2)}.icon{width:20px;height:20px;stroke:#e2e8f0;stroke-width:2}.main-content{min-height:calc(100vh - 160px);display:flex;align-items:center;justify-content:center;padding:40px 0}.login-card{background:linear-gradient(180deg,rgba(18,56,35,.85),rgba(10,38,23,.85));border:1px solid rgba(183,210,192,.18);border-radius:20px;padding:40px 30px;width:100%;max-width:450px;box-shadow:0 20px 40px rgba(0,0,0,.3)}.login-header{text-align:center;margin-bottom:30px}.login-header h1{font-size:28px;margin:0 0 10px;color:var(--text)}.login-header p{color:var(--muted);margin:0;font-size:16px}.alert{padding:12px 16px;border-radius:10px;margin-bottom:20px;display:none}.alert-success{background:rgba(16,185,129,.2);border:1px solid var(--success);color:var(--success)}.alert-error{background:rgba(239,68,68,.2);border:1px solid var(--error);color:var(--error)}.form-group{margin-bottom:20px}label{display:block;margin-bottom:8px;font-weight:600;color:var(--text)}.form-control{width:100%;padding:12px 16px;background:rgba(11,42,24,.7);border:1px solid rgba(183,210,192,.25);border-radius:10px;color:var(--text);font-size:16px;transition:all .2s ease}.form-control:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--ring)}.btn{display:inline-flex;align-items:center;justify-content:center;padding:14px 24px;border-radius:12px;font-weight:700;font-size:16px;text-decoration:none;border:none;cursor:pointer;transition:all .2s ease;width:100%}.btn-primary{background:var(--cta);color:var(--cta-text)}.btn-primary:hover{filter:brightness(.9);transform:translateY(-2px);box-shadow:0 8px 20px rgba(109,40,217,.3)}.btn-secondary{background:rgba(183,210,192,.1);color:var(--text);border:1px solid rgba(183,210,192,.25)}.btn-secondary:hover{background:rgba(183,210,192,.2);transform:translateY(-1px)}.checkbox-group{display:flex;align-items:center;gap:8px}.login-options{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.forgot-password{color:var(--accent);text-decoration:none;font-size:14px}.session-info{text-align:center;color:var(--muted);font-size:14px;margin-top:20px;padding-top:20px;border-top:1px solid rgba(183,210,192,.1)}footer{padding:30px 16px 50px;color:var(--muted);text-align:center;border-top:1px solid rgba(183,210,192,.18);background:var(--panel)}@media (max-width:576px){.login-card{padding:30px 20px}.login-options{flex-direction:column;gap:15px;align-items:flex-start}}

    /* --- ESTILOS NUEVOS PARA PERFIL --- */
    .profile-info { text-align: center; margin-bottom: 20px; }
    .avatar-circle { width: 80px; height: 80px; background: var(--accent); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 32px; color: #052e16; font-weight: bold; }
    .user-name { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
    .user-email { color: var(--muted); margin-bottom: 20px; }
    .profile-menu { display: grid; gap: 10px; text-align: left; margin-bottom: 20px; }
    .menu-item { padding: 12px; background: rgba(17, 57, 35, 0.4); border-radius: 8px; border: 1px solid rgba(183, 210, 192, 0.1); color: var(--text); text-decoration: none; display: flex; justify-content: space-between; }
    .menu-item:hover { background: rgba(34, 197, 94, 0.1); border-color: var(--accent); }
    .btn-logout { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
    .btn-logout:hover { background: rgba(239, 68, 68, 0.3); }
  </style>
</head>
<body>
  <header>
    <div class="container topbar">
      <div class="brand">
        <a href="index.html" style="text-decoration: none; display: flex; align-items: center; gap: 12px;">
          <div class="logo">FE</div>
          <span>Fit Express</span>
        </a>
      </div>
      <nav class="actions">
        <a class="icon-btn" href="index.html"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></a>
      </nav>
    </div>
  </header>

  <div class="main-content">
    <div class="container">
      <div class="row justify-content-center" style="display: flex; justify-content: center;">
        <div class="col-12" style="width: 100%; max-width: 450px;">
          <div class="login-card">
            
            <div id="loginView">
              <div class="login-header">
                <h1>Iniciar SesiÃ³n</h1>
                <p>Accede a tu cuenta para gestionar tus pedidos</p>
              </div>
              
              <div id="errorAlert" class="alert alert-error"></div>
              <div id="successAlert" class="alert alert-success">Â¡Acceso concedido!</div>
              
              <form id="loginForm">
                <div class="form-group">
                  <label for="email">Email</label>
                  <input type="email" id="email" class="form-control" placeholder="ana@example.com" required>
                </div>
                <div class="form-group">
                  <label for="password">ContraseÃ±a</label>
                  <input type="password" id="password" class="form-control" placeholder="**********" required>
                </div>
                <div class="login-options">
                  <div class="checkbox-group">
                    <input type="checkbox" id="remember">
                    <label for="remember">Recordarme</label>
                  </div>
                  <a href="B03-CambioContraseÃ±a.html" class="forgot-password">Â¿Olvidaste tu contraseÃ±a?</a>
                </div>
                <div class="form-group">
                  <button type="submit" class="btn btn-primary" id="loginBtn">Iniciar sesiÃ³n</button>
                </div>
              </form>
              
              <div style="text-align: center; margin-top: 20px;">
                <a href="B01-RegistroUsuario.html" class="btn btn-secondary">Â¿No tienes cuenta? RegÃ­strate</a>
              </div>
            </div>

            <div id="profileView" style="display: none;">
              <div class="profile-info">
                <div class="avatar-circle" id="userInitial">U</div>
                <h2 class="user-name" id="userName">Cargando...</h2>
                <p class="user-email" id="userEmailDisplay">...</p>
              </div>

              <div class="profile-menu">
                <a href="B09-Carrito.html" class="menu-item">
                  <span>ðŸ›’ Mi Carrito</span> <span>â†’</span>
                </a>
                <a href="#" class="menu-item"> <span>ðŸ“¦ Mis Pedidos</span> <span>â†’</span>
                </a>
                <a href="B03-CambioContraseÃ±a.html" class="menu-item">
                  <span>ðŸ”’ Seguridad</span> <span>â†’</span>
                </a>
              </div>

              <button id="logoutBtn" class="btn btn-logout">Cerrar SesiÃ³n</button>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>Â© <span id="y"></span> Fit Express</footer>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
    const API_URL = "http://127.0.0.1:8000"; // AsegÃºrate que coincida con uvicorn

    // Elementos DOM
    const loginView = document.getElementById('loginView');
    const profileView = document.getElementById('profileView');
    const loginForm = document.getElementById('loginForm');
    const logoutBtn = document.getElementById('logoutBtn');
    
    // --- 1. AL CARGAR LA PÃGINA: VERIFICAR SESIÃ“N ---
    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('access_token');

      if (token) {
        // Hay token, verifiquemos si es vÃ¡lido pidiendo los datos del usuario
        try {
          const response = await fetch(`${API_URL}/auth/me`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });

          if (response.ok) {
            const userData = await response.json();
            showProfile(userData);
          } else {
            // Token invÃ¡lido o expirado
            console.warn("Token invÃ¡lido, cerrando sesiÃ³n local.");
            logout();
          }
        } catch (error) {
          console.error("Error conectando con API:", error);
          // Si no hay conexiÃ³n, podrÃ­amos dejarlo logueado visualmente o forzar logout
        }
      } else {
        // No hay token, mostrar login (ya es el default)
        // Revisar si hay "Recordarme"
        checkRememberMe();
      }
    });

    // FunciÃ³n para mostrar la vista de perfil
    function showProfile(user) {
      loginView.style.display = 'none';
      profileView.style.display = 'block';
      
      document.getElementById('userName').textContent = user.nombre;
      document.getElementById('userEmailDisplay').textContent = user.email; // Ojo: API debe devolver 'email'
      document.getElementById('userInitial').textContent = user.nombre.charAt(0).toUpperCase();
    }

    // --- 2. LÃ“GICA DE LOGIN ---
    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const btn = document.getElementById('loginBtn');
      const errorAlert = document.getElementById('errorAlert');
      
      btn.disabled = true;
      btn.textContent = 'Autenticando...';
      errorAlert.style.display = 'none';

      const formData = new FormData();
      formData.append("username", document.getElementById('email').value);
      formData.append("password", document.getElementById('password').value);

      try {
        const response = await fetch(`${API_URL}/auth/token`, {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          const data = await response.json();
          
          // Guardar Token
          localStorage.setItem('access_token', data.access_token);
          
          // Guardar preferencia "Recordarme"
          if (document.getElementById('remember').checked) {
            localStorage.setItem('rememberMe', 'true');
            localStorage.setItem('savedEmail', document.getElementById('email').value);
          } else {
            localStorage.removeItem('rememberMe');
            localStorage.removeItem('savedEmail');
          }

          // Mostrar el perfil directamente con los datos que ya devolviÃ³ el login
          // (Nota: Tu endpoint /token en gestor_usuarios devuelve { access_token, token_type, usuario: {...} })
          showProfile(data.usuario);

        } else {
          const err = await response.json();
          errorAlert.textContent = err.detail || 'Credenciales incorrectas';
          errorAlert.style.display = 'block';
          btn.disabled = false;
          btn.textContent = 'Iniciar sesiÃ³n';
        }
      } catch (error) {
        errorAlert.textContent = 'Error de conexiÃ³n con el servidor';
        errorAlert.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Iniciar sesiÃ³n';
      }
    });

    // --- 3. LÃ“GICA DE LOGOUT ---
    logoutBtn.addEventListener('click', logout);

    function logout() {
      localStorage.removeItem('access_token');
      // Opcional: no borrar savedEmail si quieres recordar el usuario
      loginView.style.display = 'block';
      profileView.style.display = 'none';
      
      // Limpiar inputs
      if (localStorage.getItem('rememberMe') !== 'true') {
          document.getElementById('email').value = '';
      }
      document.getElementById('password').value = '';
      
      // Restaurar botÃ³n
      const btn = document.getElementById('loginBtn');
      btn.disabled = false;
      btn.textContent = 'Iniciar sesiÃ³n';
    }

    function checkRememberMe() {
      if (localStorage.getItem('rememberMe') === 'true') {
        const saved = localStorage.getItem('savedEmail');
        if (saved) {
          document.getElementById('email').value = saved;
          document.getElementById('remember').checked = true;
        }
      }
    }
  </script>
</body>
</html>