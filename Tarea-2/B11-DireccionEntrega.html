<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dirección de entrega — Fit Express</title>
  <meta name="description" content="Ingresa tu dirección para calcular el envío y continuar la compra.">
  <style>
    /* --- TUS ESTILOS ORIGINALES (Sin cambios visuales) --- */
    :root{--text:#ecfdf5;--muted:#b7e4cf;--panel:#0e2a1a;--ring:rgba(34,197,94,.35);--accent:#22c55e;--cta:#6d28d9;--cta-text:#f9f5ff;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;}
    *{box-sizing:border-box} html,body{margin:0;height:100%}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;background:#0b1f14;color:var(--text)}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);background:linear-gradient(180deg, rgba(11,42,24,.9), rgba(11,42,24,.65));border-bottom:1px solid rgba(183,210,192,.18);padding:8px 0}
    .container{max-width:1100px;margin:0 auto;padding:0 16px}
    .topbar{display:flex;align-items:center;gap:12px;height:60px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:900;text-decoration:none;color:inherit}
    .logo{width:32px;height:32px;border-radius:8px;background:#19c268;box-shadow:0 0 18px #19c268 inset,0 0 18px #19c268;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:14px}
    .brand span{font-size:20px;color:var(--text)}
    .actions{display:flex;align-items:center;gap:16px;margin-left:auto}
    .icon-btn{display:inline-grid;place-items:center;width:40px;height:40px;border-radius:12px;border:1px solid rgba(183,210,192,.25);background:rgba(17,57,35,.6);text-decoration:none;transition:.2s}
    .icon-btn:hover{border-color:var(--accent);background:rgba(34,197,94,.15);transform:translateY(-1px);box-shadow:0 4px 12px rgba(34,197,94,.2)}
    .icon{width:20px;height:20px;stroke:#e2e8f0;stroke-width:2}
    .page{padding:32px 16px}
    h1{font-size:clamp(24px,3.8vw,32px);margin:0 0 8px}
    .sub{color:var(--muted);margin:0 0 24px}
    .grid{display:grid;gap:24px;grid-template-columns:1fr 360px}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg, rgba(18,56,35,.55), rgba(10,38,23,.55));border:1px solid rgba(183,210,192,.18);border-radius:16px;padding:20px}
    .form-row{display:grid;gap:16px;grid-template-columns:1fr 1fr}
    .field{display:flex;flex-direction:column;gap:8px;margin-bottom:14px}
    label{font-weight:700;font-size:14px;color:#e2f7ea}
    input, select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(183,210,192,.25);background:rgba(17,57,35,.35);color:var(--text);outline:none;transition:border .15s, box-shadow .15s}
    input:focus, select:focus{border-color:var(--accent);box-shadow:0 0 0 4px var(--ring)}
    .help{color:var(--muted);font-size:12px;margin-top:-6px}
    .check{display:flex;align-items:center;gap:10px;margin:2px 0 14px}
    .cta{display:inline-flex;align-items:center;justify-content:center;background:var(--cta);color:var(--cta-text);font-weight:900;padding:14px 18px;border-radius:12px;border:1px solid rgba(0,0,0,.15);text-decoration:none;cursor:pointer;transition:.18s;font-size:15px;width:100%}
    .cta:hover{filter:brightness(.92);transform:translateY(-1px);box-shadow:0 8px 20px rgba(109,40,217,.3)}
    .cta:disabled{opacity:0.5;cursor:not-allowed;filter:none;transform:none;box-shadow:none}
    .muted-btn{background:transparent;border:1px dashed rgba(183,210,192,.35);color:var(--muted)}
    .row-actions{display:flex;gap:12px;margin-top:8px}
    .error{color:#fecaca;font-size:13px;margin-top:6px;display:none}
    .error.show{display:block}
    .summary .title{font-weight:800;margin:0 0 12px}
    .summary .line{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid rgba(183,210,192,.18)}
    .summary .line:last-child{border-bottom:0}
    .price{font-weight:900}
    .tag{display:inline-block;background:#374151;color:#9ca3af;border-radius:999px;padding:4px 10px;font-weight:800;font-size:12px}
    footer{padding:24px 16px 40px;color:var(--muted);text-align:center;border-top:1px solid rgba(183,210,192,.18);background:var(--panel);margin-top:28px}
  </style>
</head>
<body>
  <header>
    <div class="container topbar">
      <a href="index.html" class="brand"><div class="logo">FE</div><span>Fit Express</span></a>
      <nav class="actions" aria-label="Acciones">
        <a class="icon-btn" href="B09-Carrito.html" title="Volver al carrito">
          <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="#e2e8f0" stroke-width="2"/></svg>
        </a>
        <a class="icon-btn" href="B02-InicioSesion.html" title="Mi perfil">
          <svg class="icon" viewBox="0 0 24 24" fill="none">
            <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Z" stroke="#e2e8f0" stroke-width="2"></path>
            <path d="M20 21a8 8 0 1 0-16 0" stroke="#e2e8f0" stroke-width="2"></path>
          </svg>
        </a>
      </nav>
    </div>
  </header>

  <main class="page">
    <div class="container">
      <h1>Dirección de entrega</h1>
      <p class="sub">Ingresa tu dirección para validar cobertura con nuestra API.</p>

      <div class="grid">
        <section class="card">
          <form id="addressForm" novalidate>
            <div class="field">
              <label for="calle">Calle y número</label>
              <input id="calle" name="calle" autocomplete="address-line1" placeholder="Av. Providencia 1234" required />
              <div class="error" id="err-calle">Ingresa una calle válida.</div>
            </div>

            <div class="form-row">
              <div class="field">
                <label for="depto">Depto / Oficina <span class="help">(opcional)</span></label>
                <input id="depto" name="depto" autocomplete="address-line2" placeholder="Dpto 702" />
              </div>
              <div class="field">
                <label for="comuna">Comuna</label>
                <select id="comuna" name="comuna" required>
                  <option value="" hidden>Selecciona comuna</option>
                  <option value="Providencia">Providencia</option>
                  <option value="Santiago">Santiago</option>
                  <option value="Las Condes">Las Condes</option>
                  <option value="Ñuñoa">Ñuñoa</option>
                  <option value="La Reina">La Reina</option>
                  <option value="Maipu">Maipú</option> </select>
                <div class="error" id="err-comuna">Selecciona una comuna.</div>
              </div>
            </div>

            <div class="field">
              <label for="ref">Referencia para el repartidor</label>
              <input id="ref" name="ref" placeholder="Portón negro, timbre 702" />
            </div>

            <label class="check">
              <input id="fav" type="checkbox" />
              <span>Guardar como dirección favorita</span>
            </label>

            <button class="cta" type="submit" id="btnCotizar">Validar y calcular envío</button>

            <div class="row-actions">
              <a class="cta muted-btn" href="B09-Carrito.html">Volver al carrito</a>
              <button type="button" id="btnContinuar" class="cta" disabled>Continuar</button>
            </div>
          </form>
        </section>

        <aside class="card summary" id="summary">
          <p class="title">Resumen de envío <span class="tag" id="tagEstado">Pendiente</span></p>
          <div class="line"><span>Dirección</span><span id="sumDir">—</span></div>
          <div class="line"><span>Comuna</span><span id="sumComuna">—</span></div>
          <div class="line"><span>Costo de envío</span><span class="price" id="sumCosto">$—</span></div>
          <div class="line"><span>Tiempo estimado</span><span id="sumTiempo">—</span></div>
        </aside>
      </div>
    </div>
  </main>

  <footer>© <span id="y"></span> Fit Express</footer>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
    const API_URL = "http://127.0.0.1:8000";

    const form = document.getElementById('addressForm');
    const btnCotizar = document.getElementById('btnCotizar');
    const btnContinuar = document.getElementById('btnContinuar');
    
    // Elementos de resumen
    const sumDir = document.getElementById('sumDir');
    const sumComuna = document.getElementById('sumComuna');
    const sumCosto = document.getElementById('sumCosto');
    const sumTiempo = document.getElementById('sumTiempo');
    const tagEstado = document.getElementById('tagEstado');

    // Validar Sesión
    const token = localStorage.getItem('access_token');
    if (!token) {
        alert("Debes iniciar sesión para cotizar envíos.");
        window.location.href = 'B02-InicioSesion.html';
    }

    function fmtCLP(n){ return n.toLocaleString('es-CL', {style:'currency', currency:'CLP'}); }

    // LOGICA DINÁMICA CON API
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // 1. Capturar datos
      const calle = document.getElementById('calle').value.trim();
      const comuna = document.getElementById('comuna').value;
      const depto = document.getElementById('depto').value.trim();
      const ref   = document.getElementById('ref').value.trim();
      const fav   = document.getElementById('fav').checked;

      // 2. Validación Visual
      let ok = true;
      if(!calle || calle.length < 3){ 
          document.getElementById('err-calle').classList.add('show'); ok = false; 
      } else { document.getElementById('err-calle').classList.remove('show'); }
      
      if(!comuna){ 
          document.getElementById('err-comuna').classList.add('show'); ok = false; 
      } else { document.getElementById('err-comuna').classList.remove('show'); }
      
      if(!ok) return;

      // 3. Llamada a la API (Cotización Real)
      btnCotizar.textContent = "Cotizando...";
      btnCotizar.disabled = true;
      
      const datosDireccion = {
          calle: calle,
          numero: "0", // Simplificado para este ejemplo
          comuna: comuna,
          depto: depto,
          referencia: ref
      };

      try {
          const response = await fetch(`${API_URL}/pedidos/cotizar-envio`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(datosDireccion)
          });

          const data = await response.json();

          // 4. Actualizar UI con respuesta del servidor
          sumDir.textContent = depto ? `${calle}, ${depto}` : calle;
          sumComuna.textContent = comuna;

          if (data.es_valido) {
              // COBERTURA DISPONIBLE
              sumCosto.textContent = fmtCLP(data.costo);
              sumTiempo.textContent = `${data.tiempo_estimado_min} - ${data.tiempo_estimado_max} min`;
              
              tagEstado.textContent = 'Disponible';
              tagEstado.style.background = '#bbf7d0';
              tagEstado.style.color = '#166534';
              
              // Guardar datos para el siguiente paso (Checkout)
              const infoEnvio = { ...datosDireccion, costo: data.costo, eta: sumTiempo.textContent };
              localStorage.setItem('infoEnvio', JSON.stringify(infoEnvio));
              
              // Habilitar botón continuar
              btnContinuar.disabled = false;
              btnContinuar.onclick = () => {
                  window.location.href = 'B18-AsignacionDespacho.html';
              };

          } else {
              // SIN COBERTURA
              sumCosto.textContent = "—";
              sumTiempo.textContent = "Sin cobertura";
              
              tagEstado.textContent = 'Fuera de zona';
              tagEstado.style.background = '#fecaca';
              tagEstado.style.color = '#991b1b';
              
              btnContinuar.disabled = true;
              alert("Lo sentimos, por el momento no llegamos a esa comuna.");
          }

      } catch (error) {
          console.error(error);
          alert("Error de conexión con el servidor.");
      } finally {
          btnCotizar.textContent = "Validar y calcular envío";
          btnCotizar.disabled = false;
      }
    });
  </script>
</body>
</html>