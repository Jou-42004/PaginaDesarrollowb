<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tu carrito ‚Äî Fit Express</title>
  <meta name="description" content="Revisa y finaliza tu pedido.">
  <style>
    :root{--text:#ecfdf5;--muted:#b7e4cf;--panel:#0e2a1a;--ring:rgba(34,197,94,.35);--accent:#22c55e;--cta:#6d28d9;--cta-text:#f9f5ff;}
    *{box-sizing:border-box} html,body{margin:0;height:100%}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;background:#0b1f14;color:var(--text)}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);background:linear-gradient(180deg, rgba(11,42,24,.9), rgba(11,42,24,.65));border-bottom:1px solid rgba(183,210,192,.18);padding:8px 0}
    .container{max-width:1200px;margin:0 auto;padding:0 16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;height:60px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:900;flex-shrink:0;cursor:pointer;transition:transform 0.2s ease;text-decoration:none;color:inherit}
    .brand:hover{transform:scale(1.05)}
    .logo{width:32px;height:32px;border-radius:8px;background:#19c268;box-shadow:0 0 18px #19c268 inset,0 0 18px #19c268;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:14px}
    .brand span{font-size:20px;color:var(--text)}
    .actions{display:flex;align-items:center;gap:16px;margin-left:auto}
    .icon-btn{display:inline-grid;place-items:center;width:40px;height:40px;border-radius:12px;border:1px solid rgba(183,210,192,.25);background:rgba(17, 57, 35, 0.6);text-decoration:none;transition:all 0.2s ease;position:relative}
    .icon-btn:hover{border-color:var(--accent);background:rgba(34,197,94,.15);transform:translateY(-1px);box-shadow:0 4px 12px rgba(34,197,94,.2)}
    .icon{width:20px;height:20px;stroke:#e2e8f0;stroke-width:2}
    .cart-badge{position:absolute;top:-5px;right:-5px;background:var(--cta);color:white;border-radius:50%;width:18px;height:18px;font-size:10px;display:flex;align-items:center;justify-content:center;font-weight:bold}
    .main-content{padding:40px 16px;min-height:calc(100vh - 140px)}
    .cart-header{text-align:center;margin-bottom:40px}
    .cart-title{font-size:32px;margin:0;color:var(--text)}
    .empty-cart{text-align:center;padding:60px 20px;color:var(--muted)}
    .empty-cart-icon{font-size:64px;margin-bottom:20px;color:var(--muted)}
    .empty-cart h2{font-size:24px;margin-bottom:10px;color:var(--text)}
    .cart-table{width:100%;border-collapse:collapse;margin-bottom:30px;background:linear-gradient(180deg, rgba(18,56,35,.85), rgba(10,38,23,.85));border:1px solid rgba(183,210,192,.18);border-radius:12px;overflow:hidden}
    .cart-table th{background:rgba(17, 57, 35, 0.8);padding:16px 12px;text-align:left;font-weight:600;color:var(--text);border-bottom:1px solid rgba(183,210,192,.18)}
    .cart-table td{padding:16px 12px;border-bottom:1px solid rgba(183,210,192,.1)}
    .cart-table tr:last-child td{border-bottom:none}
    .product-info{display:flex;align-items:center;gap:12px}
    .product-image{width:60px;height:60px;border-radius:8px;background-size:cover;background-position:center;flex-shrink:0}
    .product-name{font-weight:700;color:var(--text)}
    .product-price, .product-total{color:var(--text);font-weight:600}
    .quantity-controls{display:flex;align-items:center;gap:8px}
    .quantity-btn{background:rgba(17, 57, 35, 0.6);color:var(--text);border:1px solid rgba(183,210,192,.25);border-radius:6px;width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s ease}
    .quantity-btn:hover{border-color:var(--accent);background:rgba(34,197,94,.15)}
    .quantity-display{min-width:30px;text-align:center;font-weight:600}
    .remove-btn{background:none;border:none;color:#ef4444;cursor:pointer;font-size:14px;padding:8px;border-radius:6px;transition:all 0.2s ease}
    .remove-btn:hover{background:rgba(239, 68, 68, 0.1)}
    .cart-summary{background:linear-gradient(180deg, rgba(18,56,35,.85), rgba(10,38,23,.85));border:1px solid rgba(183,210,192,.18);border-radius:12px;padding:24px;margin-bottom:30px}
    .summary-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0}
    .summary-label{color:var(--text)}
    .summary-value{color:var(--text);font-weight:600}
    .discount{color:#22c55e}
    .total-row{border-top:1px solid rgba(183,210,192,.18);margin-top:8px;padding-top:16px;font-weight:700;font-size:18px}
    .action-buttons{display:flex;gap:15px;margin-bottom:30px}
    .btn-back{background:rgba(17, 57, 35, 0.6);color:var(--text);border:1px solid rgba(183,210,192,.25);border-radius:12px;padding:16px 24px;font-weight:700;font-size:16px;cursor:pointer;transition:all 0.2s ease;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;flex:1}
    .btn-back:hover{border-color:var(--accent);background:rgba(34,197,94,.15);transform:translateY(-2px)}
    .checkout-btn{background:var(--cta);color:var(--cta-text);border:none;border-radius:12px;padding:16px 24px;font-weight:700;font-size:16px;cursor:pointer;transition:all 0.2s ease;text-align:center;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;flex:2}
    .checkout-btn:hover{filter:brightness(.9);transform:translateY(-2px);box-shadow:0 8px 20px rgba(109, 40, 217, 0.3)}
    .clear-cart-btn{background:rgba(239, 68, 68, 0.1);color:#ef4444;border:1px solid rgba(239, 68, 68, 0.3);border-radius:12px;padding:16px 24px;font-weight:700;font-size:16px;cursor:pointer;transition:all 0.2s ease;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;flex:1}
    .clear-cart-btn:hover{background:rgba(239, 68, 68, 0.2);transform:translateY(-2px)}
    footer{padding:30px 16px 50px;color:var(--muted);text-align:center;border-top:1px solid rgba(183,210,192,.18);background:var(--panel)}
    .toast{position:fixed;bottom:20px;right:20px;background:var(--cta);color:var(--cta-text);padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:1000;transform:translateY(100px);opacity:0;transition:all 0.3s ease}
    .toast.show{transform:translateY(0);opacity:1}
    @media (max-width:768px){.cart-table{font-size:14px}.cart-table th,.cart-table td{padding:12px 8px}.product-info{flex-direction:column;align-items:flex-start;gap:8px}.action-buttons{flex-direction:column}.cart-table{display:block;overflow-x:auto}}
  </style>
</head>
<body>
  <header>
    <div class="container topbar">
      <a href="index.html" class="brand">
        <div class="logo">FE</div>
        <span>Fit Express</span>
      </a>
      <nav class="actions" aria-label="Acciones">
        <a class="icon-btn" href="B02-InicioSesion.html" title="Mi perfil">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke-width="2" aria-hidden="true">
            <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Z"></path>
            <path d="M20 21a8 8 0 1 0-16 0"></path>
          </svg>
        </a>
        <a class="icon-btn" href="B09-Carrito.html" title="Carrito de compras">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke-width="2" aria-hidden="true">
            <path d="M6 7h12l-1 12H7L6 7Z"></path>
            <path d="M9 7V6a3 3 0 0 1 6 0v1"></path>
          </svg>
          <span class="cart-badge" id="cartBadge">0</span>
        </a>
      </nav>
    </div>
  </header>

  <div class="main-content">
    <div class="container">
      <div class="cart-header">
        <h1 class="cart-title">Tu carrito</h1>
      </div>

      <div id="loader" style="text-align:center; color: var(--muted); margin-top: 50px;">
        Cargando tu carrito...
      </div>

      <div class="empty-cart" id="emptyCart" style="display: none;">
        <div class="empty-cart-icon">üõí</div>
        <h2>Tu carrito est√° vac√≠o</h2>
        <p>¬°Descubre nuestros deliciosos bowls y snacks saludables!</p>
        <a href="B05-CatalogoMacros.html" class="checkout-btn" style="margin-top: 20px; display: inline-flex; width: auto;">
          Explorar Cat√°logo
        </a>
      </div>

      <div id="cartContent" style="display: none;">
        <table class="cart-table">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Precio</th>
              <th>Cantidad</th>
              <th>Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="cartItems">
            </tbody>
        </table>

        <div class="cart-summary">
          <div class="summary-row">
            <span class="summary-label">Subtotal</span>
            <span class="summary-value" id="subtotal">$0</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Descuento (10%)</span>
            <span class="summary-value discount" id="discount">$0</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Env√≠o</span>
            <span class="summary-value" id="shipping">$0</span>
          </div>
          <div class="summary-row total-row">
            <span class="summary-label">Total</span>
            <span class="summary-value" id="total">$0</span>
          </div>
        </div>

        <div class="action-buttons">
          <a href="B05-CatalogoMacros.html" class="btn-back">‚Üê Seguir Comprando</a>
          <button class="clear-cart-btn" id="clearCartBtn">Vaciar Carrito</button>
          <a href="B11-DireccionEntrega.html" class="checkout-btn" id="checkoutBtn">Continuar al Pago</a>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <footer>¬© <span id="y"></span> Fit Express</footer>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
    const API_URL = "http://127.0.0.1:8000";

    // Elementos DOM
    const loader = document.getElementById('loader');
    const cartItems = document.getElementById('cartItems');
    const cartBadge = document.getElementById('cartBadge');
    const subtotalElement = document.getElementById('subtotal');
    const discountElement = document.getElementById('discount');
    const shippingElement = document.getElementById('shipping');
    const totalElement = document.getElementById('total');
    const clearCartBtn = document.getElementById('clearCartBtn');
    const emptyCart = document.getElementById('emptyCart');
    const cartContent = document.getElementById('cartContent');
    const toast = document.getElementById('toast');

    // Verificar sesi√≥n
    const token = localStorage.getItem('access_token');
    
    // Redirigir si no hay token
    if (!token) {
        alert("Debes iniciar sesi√≥n para ver tu carrito.");
        window.location.href = 'B02-InicioSesion.html';
    }

    function formatPrice(price) {
      return `$${price.toLocaleString('es-CL')}`;
    }

    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }

    // --- 1. CARGAR CARRITO DESDE API ---
    async function loadCart() {
      try {
        const response = await fetch(`${API_URL}/carrito/`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const cart = await response.json();
          renderCart(cart);
        } else {
          console.error("Error cargando carrito del servidor.");
          // Si hay error, forzamos renderizado vac√≠o para que no quede pantalla negra
          renderCart(null);
        }
      } catch (error) {
        console.error("Error de conexi√≥n", error);
        renderCart(null);
      } finally {
        // Ocultar el loader pase lo que pase
        if (loader) loader.style.display = 'none';
      }
    }

    // --- 2. RENDERIZAR (Pintar en pantalla) ---
    function renderCart(cart) {
      // Validar si el carrito existe y tiene items
      if (!cart || !cart.items || cart.items.length === 0) {
        emptyCart.style.display = 'block';
        cartContent.style.display = 'none';
        cartBadge.textContent = "0";
        return;
      }

      // Si hay items, mostramos la tabla
      emptyCart.style.display = 'none';
      cartContent.style.display = 'block';
      
      // Actualizar badge
      cartBadge.textContent = cart.items.length;

      // Generar filas de la tabla
      cartItems.innerHTML = cart.items.map(item => {
        // Mapeo de datos seguros (para evitar errores si falta info)
        const prodName = item.producto ? item.producto.nombre : (item.nombre_item || "Producto sin nombre");
        const prodImg = (item.producto && item.producto.imagen_url) ? item.producto.imagen_url : "https://placehold.co/60x60?text=Sin+Foto";
        const itemTotal = item.precio_unitario * item.cantidad;

        return `
          <tr>
            <td>
              <div class="product-info">
                <div class="product-image" style="background-image: url('${prodImg}')"></div>
                <div>
                  <div class="product-name">${prodName}</div>
                </div>
              </div>
            </td>
            <td class="product-price">${formatPrice(item.precio_unitario)}</td>
            <td>
              <div class="quantity-controls">
                <span class="quantity-display">x ${item.cantidad}</span>
              </div>
            </td>
            <td class="product-total">${formatPrice(itemTotal)}</td>
            <td>
              <button class="remove-btn" onclick="deleteItem('${item.id}')" title="Eliminar producto">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18"></path>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                  <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </td>
          </tr>
        `;
      }).join('');

      // Actualizar Totales con el valor que viene del backend
      // OJO: Tu modelo Carrito tiene 'total'. Us√©moslo.
      updateCartTotals(cart.total);
    }

    function updateCartTotals(subtotal) {
      const discount = Math.round(subtotal * 0.1); // 10% Simulado
      const shipping = subtotal > 15000 ? 0 : 2000;
      const total = subtotal - discount + shipping;
      
      subtotalElement.textContent = formatPrice(subtotal);
      discountElement.textContent = formatPrice(discount);
      shippingElement.textContent = shipping === 0 ? "Gratis" : formatPrice(shipping);
      totalElement.textContent = formatPrice(total);
      
      // Guardar el total final para el siguiente paso (pago)
      localStorage.setItem('cartTotalFinal', total);
    }

    // --- 3. BORRAR UN ITEM (API) ---
    window.deleteItem = async function(itemId) {
      if(!confirm("¬øEliminar este producto?")) return;

      try {
        const response = await fetch(`${API_URL}/carrito/items/${itemId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          showToast("Producto eliminado");
          loadCart(); // Recargar para ver cambios
        } else {
          alert("Error al eliminar el producto");
        }
      } catch (error) {
        console.error(error);
      }
    }

    // --- 4. VACIAR TODO EL CARRITO (API) ---
    clearCartBtn.addEventListener('click', async () => {
      if (!confirm('¬øEst√°s seguro de vaciar todo el carrito?')) return;

      try {
        const response = await fetch(`${API_URL}/carrito/`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          showToast('Carrito vaciado');
          loadCart(); // Recargar
        }
      } catch (error) {
        console.error(error);
      }
    });

    // Inicializar
    loadCart();
  </script>
</body>
</html>